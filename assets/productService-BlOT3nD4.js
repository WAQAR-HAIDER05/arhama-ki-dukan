const m="https://api.github.com",y=async(t,e,r)=>{try{r==null||r(10);const o=(await $(t)).split(",")[1];r==null||r(30);const i=Date.now(),c=t.name.split(".").pop(),s=`product-${i}.${c}`,n=`images/products/${s}`;r==null||r(50);const l=await fetch(`${m}/repos/${e.owner}/${e.repo}/contents/${n}`,{method:"PUT",headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json",Accept:"application/vnd.github.v3+json"},body:JSON.stringify({message:`Upload product image: ${s}`,content:o,branch:e.branch||"main"})});if(r==null||r(80),!l.ok){const w=await l.json();throw new Error(w.message||`GitHub upload failed: ${l.status}`)}const f=await l.json();return r==null||r(100),{success:!0,url:`https://raw.githubusercontent.com/${e.owner}/${e.repo}/${e.branch||"main"}/${n}`,fileName:s}}catch(a){return console.error("GitHub upload error:",a),{success:!1,error:a instanceof Error?a.message:"Upload failed"}}},S=async(t,e,r)=>{const a=[];for(let o=0;o<t.length;o++){const i=t[o],c=await y(i,e,s=>{const n=(o+s/100)/t.length*100;r==null||r(o,s,n)});a.push(c)}return a},$=t=>new Promise((e,r)=>{const a=new FileReader;a.readAsDataURL(t),a.onload=()=>e(a.result),a.onerror=o=>r(o)}),u={owner:"WAQAR-HAIDER05",repo:"ecom-data-",token:"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",branch:"main"},p=()=>({owner:u.owner,repo:u.repo,token:u.token,branch:u.branch}),d=()=>{const t=p();return!!(t.owner&&t.owner!=="YOUR_GITHUB_USERNAME"&&t.repo&&t.token&&t.token!=="YOUR_PERSONAL_ACCESS_TOKEN")},h="https://api.github.com",C=async(t,e)=>{try{if(!d())return{success:!1,error:"GitHub configuration is incomplete. Please check config/github.ts"};const r=p();e==null||e("Uploading images...",0);const a=await S(t.images,r,(n,l,f)=>{e==null||e("Uploading images...",f*.4)}),o=a.filter(n=>!n.success);if(o.length>0)return{success:!1,error:`Failed to upload ${o.length} image(s)`};e==null||e("Processing product data...",50);const i=a.map(n=>n.url).filter(n=>n),c={id:I(),name:t.name,description:t.description,price:t.price,originalPrice:t.originalPrice,currency:"PKR",images:i,category:t.category,subcategory:t.subcategory,material:t.material,brand:t.brand,gender:t.gender,inStock:t.inStock,featured:t.featured,isNew:t.isNew,isOnSale:t.isOnSale,tags:A(t),specifications:U(t),rating:0,reviewCount:0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};e==null||e("Saving product to database...",70);let s=!1;try{s=await k(c,r)}catch(n){console.warn("GitHub save failed, using localStorage fallback:",n);const l=JSON.parse(localStorage.getItem("user-products")||"[]");l.push(c),localStorage.setItem("user-products",JSON.stringify(l)),s=!0}if(!s){console.warn("Using localStorage as final fallback");const n=JSON.parse(localStorage.getItem("user-products")||"[]");n.push(c),localStorage.setItem("user-products",JSON.stringify(n))}return e==null||e("Product created successfully!",100),{success:!0,product:c}}catch(r){return console.error("Error creating product:",r),{success:!1,error:r instanceof Error?r.message:"An unexpected error occurred"}}},A=t=>{const e=[];return t.category==="watches"?(e.push("timepiece","watch","luxury watch"),t.subcategory.includes("smart")&&e.push("smart watch","technology")):t.category==="jewelry"&&(e.push("jewelry","accessory","luxury jewelry"),t.subcategory.includes("bridal")&&e.push("wedding","bridal","pakistani wedding")),t.material&&(e.push(t.material.toLowerCase()),t.material.toLowerCase().includes("gold")&&e.push("precious metal","luxury")),t.brand&&e.push(t.brand.toLowerCase(),"branded"),e.push(t.gender),t.gender==="female"?e.push("women","ladies"):t.gender==="male"&&e.push("men","gents"),e.push("pakistan","karachi","lahore","islamabad","authentic"),[...new Set(e)]},U=t=>{const e={};return t.material&&(e.Material=t.material),t.brand&&(e.Brand=t.brand),e.Gender=t.gender.charAt(0).toUpperCase()+t.gender.slice(1),e.Category=t.category.charAt(0).toUpperCase()+t.category.slice(1),e.Condition="New",e.Warranty="Available",e.Origin="Authentic",t.category==="watches"&&(e.Type="Analog",e["Water Resistance"]="Yes"),e},H=async()=>{try{if(console.log("🔧 getUserProducts called"),console.log("⚙️ GitHub configured:",d()),!d()){console.warn("⚠️ GitHub not configured, using localStorage");const r=localStorage.getItem("user-products"),a=r?JSON.parse(r):[];return console.log("💾 LocalStorage products:",a),a}const t=p();console.log("🔧 GitHub config:",{owner:t.owner,repo:t.repo});const e=await g(t);return console.log("🐙 GitHub products:",e),e||[]}catch(t){console.error("❌ Error fetching products, falling back to localStorage:",t);const e=localStorage.getItem("user-products"),r=e?JSON.parse(e):[];return console.log("💾 Fallback localStorage products:",r),r}},R=async t=>{try{if(!d())return!1;const e=p(),r=await g(e);if(!r)return!1;const a=r.filter(o=>o.id!==t);return await b(a,e)}catch(e){return console.error("Error deleting product:",e),!1}},k=async(t,e)=>{try{const a=[...await g(e)||[],t];return await b(a,e)}catch(r){return console.error("Error saving product:",r),!1}},b=async(t,e)=>{try{const r="data/products.json",a=JSON.stringify(t,null,2),o=btoa(unescape(encodeURIComponent(a)));let i="";try{const s=await fetch(`${h}/repos/${e.owner}/${e.repo}/contents/${r}`,{headers:{Authorization:`Bearer ${e.token}`,Accept:"application/vnd.github.v3+json"}});s.ok&&(i=(await s.json()).sha)}catch{}return(await fetch(`${h}/repos/${e.owner}/${e.repo}/contents/${r}`,{method:"PUT",headers:{Authorization:`Bearer ${e.token}`,"Content-Type":"application/json",Accept:"application/vnd.github.v3+json"},body:JSON.stringify({message:`Update products database - ${new Date().toISOString()}`,content:o,sha:i||void 0,branch:e.branch||"main"})})).ok}catch(r){return console.error("Error saving products to GitHub:",r),!1}},g=async t=>{try{const r=`${h}/repos/${t.owner}/${t.repo}/contents/data/products.json`;console.log("🌐 Fetching from GitHub API:",r);const a=await fetch(r,{method:"GET",headers:{Authorization:`Bearer ${t.token}`,Accept:"application/vnd.github.v3+json"}});if(console.log("📡 Response status:",a.status),console.log("📡 Response ok:",a.ok),!a.ok)return console.log("❌ Products file does not exist yet, returning empty array"),[];const o=await a.json(),i=atob(o.content),c=JSON.parse(i);return console.log("✅ Successfully fetched products via API:",c),Array.isArray(c)?c:[]}catch(e){console.log("❌ GitHub API failed, trying raw URL fallback"),console.error("API Error details:",e);try{const r=`https://raw.githubusercontent.com/${t.owner}/${t.repo}/${t.branch||"main"}/data/products.json`;console.log("🌐 Fallback to raw URL:",r);const a=await fetch(r,{method:"GET",cache:"no-cache"});if(!a.ok)return console.log("❌ Raw URL also failed, returning empty array"),[];const o=await a.json();return console.log("✅ Successfully fetched products via raw URL:",o),Array.isArray(o)?o:[]}catch(r){return console.log("❌ Both API and raw URL failed, returning empty array"),console.error("Fallback error:",r),[]}}},I=()=>`product_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;export{C as c,R as d,H as g};
